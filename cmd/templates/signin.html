<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>



    <link rel="stylesheet" href="signin.css">
    <style>
    html {
        height: 100%;
    }

    body {
        font-family: sans-serif;
        height: 100%;
        margin: 0px;
        padding: 0px;
        background-image: linear-gradient(#383f89, #8d2b2c);
    }

    .signin-container {
        color: white;
        max-width: 250px;
        margin: 100px auto;
        padding: 5% 4%;
    }

    .signin-string, a {
        text-align: center;
        color: white;
        text-decoration: none;
        font-weight: bold;
    }

    label {
        font-size: 0.9em;
    }

    input, button {
        width: 100%;
        padding: 12px 20px;
        margin: 8px 0;
        border: 1px solid white;
        border-radius: 4px;
        box-sizing: border-box;
    }

    button, input[type="submit"] {
        padding: 7px 20px;
        color: #573663;
        background-color: #e1d2d2;
        font-size: 1em;
        font-weight: bold;
    }

    input{
        background-color: #441c6800;
        color: white;
        caret-color: white;
    }

    input[type=text] {
    }

    input[type=text]:focus {
    }

    input[type=password] {
    }

    input[type=password]:focus {
    }
    </style>

</head>

<body>
<div class="signin-container">
    <p class="signin-string"><a href="/">setonotes</a></p>
    <div class="input-field">
        <label>username</label><br>
        <input id="username" type="text" value="" autofocus
            autocomplete="off">
    </div>
    <div class="input-field">
        <label>password</label><br>
        <input id="password" type="password" value="">
    </div>
    <button onclick="go()"><b>Sign In</b></button>
</div>

<form id="hiddenAuthForm" method="POST">
    <input id="hiddenUsername" type="hidden" name="username">
    <input id="hiddenPassword" type="hidden" name="password">
</form>

</body>

<script>

function go() {
    let username = document.getElementById("username").value;

    let requestData = JSON.stringify({
        username: username,
    });

    $.ajax({
        type: "POST",
        url: "/api/salts",
        dataType: 'json',
        data: requestData,
    })
    .then(function(response){
        // get both authentication and encryption salt
        // TODO: Write base64ToUint8Array()
        let authSalt = new Uint8Array(base64ToArrayBuffer(response.auth_salt));
        console.log('auth salt: ' + authSalt);
        let encryptionSalt = new Uint8Array(base64ToArrayBuffer(response.encryption_salt));

        // get submitted password
        let submittedPassword = document.getElementById("password").value;

        // generate and store encryption key
        getBitsFromPassword(submittedPassword, encryptionSalt)
        .then(function(encryptionKey){
            // TODO: store encryption key somewhere
        });

        // generate and submit auth key (with username)
        getBitsFromPassword(submittedPassword, authSalt)
        .then(function(authKey){
            // populate and submit hidden auth form
            document.getElementById("hiddenUsername").value = username;
            document.getElementById("hiddenPassword").value =
                arrayBufferToBase64(authKey);

            document.getElementById("hiddenAuthForm").submit();
        });
    })
    .catch(function(){
        console.log("TODO: Replace this with user-facing message.");
    });
}

/**
 * Get ArrayBuffer of PBKDF2 bits from the given (password, salt) pair
 *
 * `salt` is expected to be of type Uint8(16)
 */
async function getBitsFromPassword(password, salt) {
    let encoder = new TextEncoder();

    const importedPassword = await window.crypto.subtle.importKey(
        "raw",
        encoder.encode(password),
        {name: "PBKDF2"},
        false,
        ["deriveBits", "deriveKey"]
    );

    return window.crypto.subtle.deriveBits(
        {
            "name": "PBKDF2",
            salt: salt,
            "iterations": 3e5,
            "hash": "SHA-256"
        },
        importedPassword,
        128
    );
}

/**
 * Convert an ArrayBuffer to a base-64 string
 * from here:
 *   https://stackoverflow.com/questions/9267899
 *   /arraybuffer-to-base64-encoded-string
 */
function arrayBufferToBase64(buffer) {
    let binary = '';
    let bytes = new Uint8Array(buffer);
    let len = bytes.byteLength;

    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }

    return window.btoa(binary);
}

/**
 * Convert a base-64 string to an ArrayBuffer
 * from here:
 *   https://stackoverflow.com/a/21797381/9986578
 */
function base64ToArrayBuffer(base64) {
    var binaryString = window.atob(base64);
    var len = binaryString.length;
    var bytes = new Uint8Array(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

</script>

</html>
